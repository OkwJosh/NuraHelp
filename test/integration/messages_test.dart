import 'package:flutter_test/flutter_test.dart';import 'package:get/get.dart';import 'package:flutter_dotenv/flutter_dotenv.dart';import 'package:mockito/mockito.dart';import 'package:nurahelp/app/data/models/message_models/conversation_model.dart';import 'package:nurahelp/app/data/services/app_service.dart';class MockAppService extends Mock implements AppService {}class MockMessagesController extends GetxController {  final RxList<ConversationModel> conversations = <ConversationModel>[].obs;  final RxBool isLoading = false.obs;  void addConversation(ConversationModel conversation) {    conversations.add(conversation);  }  void removeConversation(String userId) {    conversations.removeWhere((c) => c.userId == userId);  }  void markAsRead(String userId) {    final index = conversations.indexWhere((c) => c.userId == userId);    if (index != -1) {      conversations[index] = ConversationModel(        userId: conversations[index].userId,        userName: conversations[index].userName,        userType: conversations[index].userType,        lastMessage: conversations[index].lastMessage,        lastTimestamp: conversations[index].lastTimestamp,        lastSender: conversations[index].lastSender,        unreadCount: 0,      );    }  }  List<ConversationModel> searchConversations(String query) {    return conversations        .where((c) => c.userName.toLowerCase().contains(query.toLowerCase()))        .toList();  }  List<ConversationModel> getUnreadConversations() {    return conversations.where((c) => c.hasUnread).toList();  }  int getTotalUnreadCount() {    return conversations.fold<int>(0, (sum, c) => sum + c.unreadCount);  }}void main() {  late MockMessagesController messagesController;  setUpAll(() async {    dotenv.testLoad(mergeWith: {'NEXT_PUBLIC_API_URL': 'https://api.test.com'});    Get.put<AppService>(MockAppService());  });  setUp(() {    messagesController = MockMessagesController();    Get.put<MockMessagesController>(messagesController);  });  tearDown(() {    Get.reset();  });  group('Messages Feature - Integration Tests', () {    test('should initialize messages controller', () {      expect(messagesController, isNotNull);      expect(messagesController.conversations, isEmpty);    });    test('should start with empty conversations list', () {      expect(messagesController.conversations, isEmpty);    });    test('should add conversation to list', () {      final testConversation = ConversationModel(        userId: 'doc-001',        userName: 'Dr. John',        userType: 'Doctor',        lastMessage: 'Hello, how are you?',        lastTimestamp: DateTime.now(),        lastSender: 'doc-001',        unreadCount: 1,      );      messagesController.addConversation(testConversation);      expect(messagesController.conversations.length, 1);      expect(messagesController.conversations.first.userName, 'Dr. John');    });    test('should add multiple conversations', () {      final conv1 = ConversationModel(        userId: 'doc-001',        userName: 'Dr. John',        userType: 'Doctor',        lastMessage: 'Hello',        lastTimestamp: DateTime.now(),        lastSender: 'doc-001',        unreadCount: 1,      );      final conv2 = ConversationModel(        userId: 'doc-002',        userName: 'Dr. Jane',        userType: 'Doctor',        lastMessage: 'Hi there',        lastTimestamp: DateTime.now(),        lastSender: 'doc-002',        unreadCount: 2,      );      messagesController.addConversation(conv1);      messagesController.addConversation(conv2);      expect(messagesController.conversations.length, 2);      expect(        messagesController.conversations.map((c) => c.userName).toList(),        contains('Dr. John'),      );    });    test('should filter conversations by search query', () {      final conv1 = ConversationModel(        userId: 'doc-001',        userName: 'Dr. Johnson',        userType: 'Doctor',        lastMessage: 'Hello',        lastTimestamp: DateTime.now(),        lastSender: 'doc-001',        unreadCount: 1,      );      final conv2 = ConversationModel(        userId: 'doc-002',        userName: 'Dr. Smith',        userType: 'Doctor',        lastMessage: 'Hi',        lastTimestamp: DateTime.now(),        lastSender: 'doc-002',        unreadCount: 0,      );      messagesController.addConversation(conv1);      messagesController.addConversation(conv2);      final filtered = messagesController.searchConversations('Johnson');      expect(filtered.length, 1);      expect(filtered.first.userName, 'Dr. Johnson');    });    test('should mark conversation as read', () {      final testConversation = ConversationModel(        userId: 'doc-001',        userName: 'Dr. John',        userType: 'Doctor',        lastMessage: 'Hello',        lastTimestamp: DateTime.now(),        lastSender: 'doc-001',        unreadCount: 5,      );      messagesController.addConversation(testConversation);      expect(messagesController.conversations.first.unreadCount, 5);      messagesController.markAsRead('doc-001');      expect(messagesController.conversations.first.unreadCount, 0);    });    test('should track unread message count', () {      final conv1 = ConversationModel(        userId: 'doc-001',        userName: 'Dr. John',        userType: 'Doctor',        lastMessage: 'Hello',        lastTimestamp: DateTime.now(),        lastSender: 'doc-001',        unreadCount: 3,      );      final conv2 = ConversationModel(        userId: 'doc-002',        userName: 'Dr. Jane',        userType: 'Doctor',        lastMessage: 'Hi',        lastTimestamp: DateTime.now(),        lastSender: 'doc-002',        unreadCount: 2,      );      messagesController.addConversation(conv1);      messagesController.addConversation(conv2);      final totalUnread = messagesController.getTotalUnreadCount();      expect(totalUnread, 5);    });    test('should get conversations with unread messages', () {      final conv1 = ConversationModel(        userId: 'doc-001',        userName: 'Dr. John',        userType: 'Doctor',        lastMessage: 'Hello',        lastTimestamp: DateTime.now(),        lastSender: 'doc-001',        unreadCount: 3,      );      final conv2 = ConversationModel(        userId: 'doc-002',        userName: 'Dr. Jane',        userType: 'Doctor',        lastMessage: 'Hi',        lastTimestamp: DateTime.now(),        lastSender: 'doc-002',        unreadCount: 0,      );      messagesController.addConversation(conv1);      messagesController.addConversation(conv2);      final unreadConversations = messagesController.getUnreadConversations();      expect(unreadConversations.length, 1);      expect(unreadConversations.first.userName, 'Dr. John');    });    test('should remove conversation', () {      final testConversation = ConversationModel(        userId: 'doc-001',        userName: 'Dr. John',        userType: 'Doctor',        lastMessage: 'Hello',        lastTimestamp: DateTime.now(),        lastSender: 'doc-001',        unreadCount: 1,      );      messagesController.addConversation(testConversation);      expect(messagesController.conversations.length, 1);      messagesController.removeConversation('doc-001');      expect(messagesController.conversations, isEmpty);    });    test('should handle conversation timestamp', () {      final now = DateTime.now();      final testConversation = ConversationModel(        userId: 'doc-001',        userName: 'Dr. John',        userType: 'Doctor',        lastMessage: 'Hello',        lastTimestamp: now,        lastSender: 'doc-001',        unreadCount: 1,      );      messagesController.addConversation(testConversation);      expect(messagesController.conversations.first.lastTimestamp, now);    });    test('should validate conversation model structure', () {      final testConversation = ConversationModel(        userId: 'doc-001',        userName: 'Dr. Test',        userType: 'Doctor',        lastMessage: 'Test message',        lastTimestamp: DateTime.now(),        lastSender: 'doc-001',        unreadCount: 0,        userEmail: 'test@hospital.com',        userPhone: '+1234567890',      );      expect(testConversation.userId, 'doc-001');      expect(testConversation.userName, 'Dr. Test');      expect(testConversation.userType, 'Doctor');      expect(testConversation.userEmail, 'test@hospital.com');    });  });}